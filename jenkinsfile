// Define Active Choices parameter as a job property (required for $class-style parameters)
properties([
    parameters([
        [$class: 'CascadeChoiceParameter',
            choiceType: 'PT_CHECKBOX',
            description: 'Select one or more options',
            name: 'Builds',
            // Default selected options (comma-separated). Adjust as needed.
            value: 'jenkins1,jenkins2',
            // 'randomName' is used as an internal identifier for the parameter; renamed for clarity
            randomName: 'buildsParameterChoice',
            referencedParameters: '',
            script: [$class: 'GroovyScript', script: [sandbox: true, script: """
                return ['jenkins1','jenkins2']
            """], fallbackScript: [sandbox: true, script: "return ['Error loading options']"]]
        ]
    ])
])

pipeline {
    agent any
    
    parameters {
        choice(name: 'Branch', choices: ['development', 'main'], description: 'Branch to build')
    }
    
    stages {


        stage('Initialize') {
            steps {
                script {
                    env.SUCCESSFUL_STAGES = ''
                }
            }
        }

        stage('Build jenkins1') {
            when {
                expression {
                    // params.Builds comes from the Active Choices parameter (comma-separated)
                    def raw = params.Builds ?: ''
                    return raw.tokenize(',').collect { it.trim() }.contains('jenkins1')
                }
            }
            steps {
                script {
                    try {
                        // def encodedBranch = java.net.URLEncoder.encode(env.BRANCH_NAME, "UTF-8")
                        def encodedBranch = java.net.URLEncoder.encode(params.Branch, "UTF-8")
                        build job: "GitHub jenkins/jenkins1/${encodedBranch}"
                        env.SUCCESSFUL_STAGES += ',Build jenkins1'
                    } catch (Exception e) {
                        echo "Build of jenkins1 failed: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                    }       
                }
            }
        }

        stage('Build jenkins2') {
            when {
                expression {
                    def raw = params.Builds ?: ''
                    return raw.tokenize(',').collect { it.trim() }.contains('jenkins2')
                }
            }
            steps {
                script {
                    try {
                        //def encodedBranch = java.net.URLEncoder.encode(env.BRANCH_NAME, "UTF-8")
                        def encodedBranch = java.net.URLEncoder.encode(params.Branch, "UTF-8")
                        build job: "GitHub jenkins/jenkins2/${encodedBranch}"
                        env.SUCCESSFUL_STAGES += ',Build jenkins2'
                    } catch (Exception e) {
                        echo "Build of jenkins2 failed: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }

        stage('Summary') {
            steps {
                script {
                    def successfulStages = env.SUCCESSFUL_STAGES.split(',').findAll { it.trim() != '' }
                    echo "==================== BUILD SUMMARY ===================="
                    echo "Total successful stages: ${successfulStages.size()}"
                    successfulStages.each { stage ->
                        echo "✓ ${stage.trim()}"
                    }
                    echo "======================================================"
                    
                    // Check if all stages succeeded
                    env.ALL_SUCCESSFUL = (currentBuild.result == null || currentBuild.result == 'SUCCESS')
                }
            }
        }

        stage('All Stages Succeeded') {
            when {
                expression {
                    return env.ALL_SUCCESSFUL == 'true'
                }
            }
            steps {
                script {
                    echo "✓ All stages completed successfully!"
                    // Add your action here (e.g., send notification, deploy, etc.)
                    // Example:
                    // sh 'echo "Triggering deployment..."'
                    // build job: 'deploy-job'
                }
            }
        }
    }
}








// pipeline {
//     agent any
    
//     parameters {
//         activeChoice(
//             name: 'MY_CHOICE',
//             description: 'Select one or more options',
//             choiceType: 'PT_CHECKBOX',  // PT_CHECKBOX = checkboxes (multi-select), PT_SINGLE_SELECT = dropdown single
//             groovyScript: '''
//                 return [
//                     "option1",
//                     "option2",
//                     "option3",
//                     "option4"
//                 ]
//             ''',
//             fallbackScript: '''
//                 return ["Error loading options"]
//             '''
//         )
//     }
    
//     stages {
//         stage('Show Selected Options') {
//             steps {
//                 script {
//                     def selected = []
//                     if (params.MY_CHOICE) {
//                         selected = params.MY_CHOICE.split(',').collect { it.trim() }.findAll { it }
//                     }

//                     echo "You selected: ${selected.join(', ') ?: 'nothing'}"
                    
//                     if (selected.isEmpty()) {
//                         echo "Warning: No options were selected."
//                     } else {
//                         selected.each { echo " → ${it}" }
//                     }
//                 }
//             }
//         }
    

//     // parameters {
//     // //choice(name: 'BRANCH', choices: ['development', 'main'], description: 'Branch to build')
//     // // Allow multiple selections for TARGETS
//     //     choice(
//     //         name: 'MY_CHOICE',
//     //         choices: ['option1', 'option2', 'option3'],
//     //         description: 'Select an option'
//     //     )
//     // }



//         stage('Initialize') {
//             steps {
//                 script {
//                     env.SUCCESSFUL_STAGES = ''
//                 }
//             }
//         }

//         stage('Build jenkins1') {
//             steps {
//                 script {
//                     try {
//                         // def encodedBranch = java.net.URLEncoder.encode(env.BRANCH_NAME, "UTF-8")
//                         def encodedBranch = java.net.URLEncoder.encode(params.BRANCH, "UTF-8")
//                         build job: "GitHub jenkins/jenkins1/${encodedBranch}"
//                         env.SUCCESSFUL_STAGES += ',Build jenkins1'
//                     } catch (Exception e) {
//                         echo "Build of jenkins1 failed: ${e.getMessage()}"
//                         currentBuild.result = 'UNSTABLE'
//                     }       
//                 }
//             }
//         }

//         stage('Build jenkins2') {
//             steps {
//                 script {
//                     try {
//                         //def encodedBranch = java.net.URLEncoder.encode(env.BRANCH_NAME, "UTF-8")
//                         def encodedBranch = java.net.URLEncoder.encode(params.BRANCH, "UTF-8")
//                         build job: "GitHub jenkins/jenkins2/${encodedBranch}"
//                         env.SUCCESSFUL_STAGES += ',Build jenkins2'
//                     } catch (Exception e) {
//                         echo "Build of jenkins2 failed: ${e.message}"
//                         currentBuild.result = 'UNSTABLE'
//                     }
//                 }
//             }
//         }

//         stage('Summary') {
//             steps {
//                 script {
//                     def successfulStages = env.SUCCESSFUL_STAGES.split(',').findAll { it.trim() != '' }
//                     echo "==================== BUILD SUMMARY ===================="
//                     echo "Total successful stages: ${successfulStages.size()}"
//                     successfulStages.each { stage ->
//                         echo "✓ ${stage.trim()}"
//                     }
//                     echo "======================================================"
                    
//                     // Check if all stages succeeded
//                     env.ALL_SUCCESSFUL = (currentBuild.result == null || currentBuild.result == 'SUCCESS')
//                 }
//             }
//         }

//         stage('All Stages Succeeded') {
//             when {
//                 expression {
//                     return env.ALL_SUCCESSFUL == 'true'
//                 }
//             }
//             steps {
//                 script {
//                     echo "✓ All stages completed successfully!"
//                     // Add your action here (e.g., send notification, deploy, etc.)
//                     // Example:
//                     // sh 'echo "Triggering deployment..."'
//                     // build job: 'deploy-job'
//                 }
//             }
//         }
//     }
// }


// /*
// Codepaths obtained with
// Jenkins -  Manage Jenkins - Script Console
// Jenkins.instance.getAllItems().each { item ->
//     println(item.fullName)
// }
// */