pipeline {
    agent any

    stages {
        stage('Run jenkins1 then jenkins2') {
            steps {
                script {
                    // Step 1: Trigger jenkins1 and WAIT for it to finish
                    echo "Starting jenkins1..."
                    def run1 = build job: 'jenkins1',
                                     wait: true,          // wait until it finishes
                                     propagate: false     // don't fail yet – we check result manually

                    // Check if jenkins1 succeeded
                    if (run1.result != 'SUCCESS') {
                        error "jenkins1 failed with result: ${run1.result}. Stopping pipeline."
                    }
                    echo "jenkins1 completed successfully!"

                    // Step 2: Only if jenkins1 passed → trigger jenkins2
                    echo "Starting jenkins2..."
                    def run2 = build job: 'jenkins2',
                                     wait: true,
                                     propagate: true      // now we let failure propagate

                    echo "jenkins2 finished with result: ${run2.result}"
                }
            }
        }
    }

    post {
        success { echo "Both jenkins1 and jenkins2 ran successfully!" }
        failure { echo "Pipeline failed (likely because jenkins1 failed or was aborted)." }
        always  { echo "End of orchestrator pipeline." }
    }
}